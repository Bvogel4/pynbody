import warnings

import numpy.testing as npt
import pytest

import pynbody

results = {'v': [ -8.4318334 ,  -7.52727191,  -8.55756858,  -7.30202671,
           -8.41616925,  -8.5901894 ,  -7.31028468,  -8.12565159,
           -7.31518039,  -8.27380601,  -7.4544367 ,  -7.33062685,
           -7.49427742,  -7.54732334,  -8.48062923,  -7.55131115,
           -7.4688558 ,  -7.35175012,  -7.30811722,  -7.32948685,
           -7.31248768,  -7.35615838,  -7.35173455,  -7.3533272 ,
           -7.80099082,  -8.43374329,  -8.10182908,  -7.36861107,
           -7.29332819,  -7.60060675,  -8.40313886,  -7.32783517,
           -7.33496155,  -7.43744317,  -7.32186524,  -7.39949592,
           -7.38406259,  -7.67425681,  -7.45984135,  -7.51371185,
           -7.49645462,  -7.52048843,  -7.70642421,  -7.59838561,
           -7.95290614,  -7.79978215,  -7.81983398,  -8.10895307,
           -8.18092218,  -8.43809995,  -8.75108248,  -8.87727426,
           -9.8070235 , -12.2256384 ],
           'i': [ -9.37239259,  -8.61520494,  -9.51952974,  -8.48018286,
           -9.41245481,  -9.55877876,  -8.47512415,  -9.17036249,
           -8.48540295,  -9.30909755,  -8.57185253,  -8.49045091,
           -8.61798039,  -8.65119512,  -9.47017277,  -8.65575078,
           -8.59919548,  -8.50870863,  -8.49204726,  -8.49641349,
           -8.49738915,  -8.51396949,  -8.51061231,  -8.51133183,
           -8.86347368,  -9.45457537,  -9.14830751,  -8.52422242,
           -8.48938537,  -8.69776393,  -9.43459827,  -8.51486725,
           -8.52239391,  -8.58473181,  -8.51439489,  -8.55252743,
           -8.56635275,  -8.75172718,  -8.61466123,  -8.65943626,
           -8.65131001,  -8.66957709,  -8.81021473,  -8.74422862,
           -9.00397257,  -8.92882127,  -8.94942337,  -9.1815767 ,
           -9.27461736,  -9.48783697,  -9.760549  ,  -9.92439524,
          -10.58895997, -12.69117395]
           }

@pytest.mark.parametrize("band, result", results.items())
def test_luminosity(band, result):
    f = pynbody.load("testdata/gasoline_ahf/g15784.lr.01024.gz")
    with warnings.catch_warnings(record=True) as w:
        warnings.filterwarnings('ignore')
        f.st['massform'] # noqa - trigger starlog load and ignore any warnings

    mag = pynbody.analysis.luminosity.calc_mags(f.st, band=band)
    npt.assert_allclose(mag[::5000], result, rtol=1e-5)
